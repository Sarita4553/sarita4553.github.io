<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register for Push Notifications</title>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <script>
    window.OneSignal = window.OneSignal || [];

    OneSignal.push(function () {
      console.log("Initializing OneSignal...");

      OneSignal.init({
        appId: "d2783680-973f-459a-8550-686b0f9c77b4",
        promptOptions: {
          slidedown: {
            enabled: true
          }
        }
      });

      OneSignal.showSlidedownPrompt();

      OneSignal.on("subscriptionChange", function (isSubscribed) {
        console.log("Subscription changed:", isSubscribed);

        if (isSubscribed) {
          OneSignal.getUserId().then(function (playerId) {
            console.log("Player ID:", playerId);

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("userId");
            console.log("User ID:", userId);

            if (userId && playerId) {
              const endpoint = "https://script.google.com/macros/s/AKfycbyujkQvd_1jWe5EAXZDXzY9cz2TZyiAk8fq-QURJ1yEne2ht_ycxZsYDWxrW782u3p9AA/exec";
              const queryString = `?userId=${encodeURIComponent(userId)}&playerId=${encodeURIComponent(playerId)}`;

              fetch(endpoint + queryString)
                .then((res) => res.json())
                .then((data) => {
                  console.log("Response:", data);
                  document.body.innerHTML = "<h2>✅ Device Registered Successfully</h2>";
                })
                .catch((error) => {
                  console.error("Error sending data:", error);
                  document.body.innerHTML = "<h2>❌ Failed to register device</h2>";
                });
            } else {
              document.body.innerHTML = "<h2>⚠️ Missing userId or playerId</h2>";
            }
          });
        } else {
          document.body.innerHTML = "<h2>🔕 Notifications not enabled</h2>";
        }
      });
    });
  </script>
</head>
<body>
  <h2>🔄 Setting up notifications...</h2>
</body>
</html>
