<script>
  window.OneSignal = window.OneSignal || [];

  console.log("OneSignal setup starting...");

  OneSignal.push(function () {
    console.log("OneSignal init firing...");

    OneSignal.init({
      appId: "d2783680-973f-459a-8550-686b0f9c77b4",
    });

    console.log("OneSignal initialized.");

    OneSignal.on("subscriptionChange", function (isSubscribed) {
      console.log("subscriptionChange event fired:", isSubscribed);

      if (isSubscribed) {
        OneSignal.getUserId().then(function (playerId) {
          console.log("Received playerId:", playerId);
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get("userId");

          if (userId && playerId) {
            console.log("Sending data to script...");
            fetch("https://script.google.com/macros/s/AKfycbySkTTqF-tyPWtv3qrWWxxp1VrD4W2MyVPU1C1LCBI_MRn8sCtjtbvCD1igQ3ykIs86ag/exec", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ userId, playerId })
            }).then(() => {
              document.body.innerHTML = "<h2>Device Registered</h2>";
            }).catch((e) => {
              document.body.innerHTML = "<h2>Error registering device</h2>";
              console.error("Fetch error:", e);
            });
          } else {
            document.body.innerHTML = "<h2>Error: Missing userId or playerId</h2>";
            console.error("Missing userId or playerId");
          }
        });
      } else {
        document.body.innerHTML = "<h2>Please enable notifications</h2>";
        console.warn("User is not subscribed to notifications.");
      }
    });
  });
</script>
