<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register for Push Notifications</title>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

  <script>
    window.OneSignal = window.OneSignal || [];

    OneSignal.push(function () {
      console.log("Initializing OneSignal...");

      OneSignal.init({
        appId: "d2783680-973f-459a-8550-686b0f9c77b4",
        promptOptions: {
          slidedown: {
            enabled: true
          }
        }
      });

      // Automatically show the browser permission prompt
      OneSignal.showSlidedownPrompt();

      // When subscription state changes
      OneSignal.on("subscriptionChange", function (isSubscribed) {
        console.log("Subscription changed:", isSubscribed);

        if (isSubscribed) {
          OneSignal.getUserId().then(function (playerId) {
            console.log("Player ID:", playerId);

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("userId");
             console.log("userId ID:", userId);
            if (userId && playerId) {
              console.log("Sending to Google Apps Script...");
              fetch("https://script.google.com/macros/s/AKfycbyEDFQxdYQXprKNzBTsZB1n9JgE7POS2nLaYCFnZkLi25XQ0_S3qU5VMBkigBkEbmh7iw/exec", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ userId, playerId })
              })
              .then(() => {
                document.body.innerHTML = "<h2>âœ… Device Registered Successfully</h2>";
              })
              .catch((error) => {
                console.error("Error sending data:", error);
                document.body.innerHTML = "<h2>âŒ Failed to register device</h2>";
              });
            } else {
              document.body.innerHTML = "<h2>âš ï¸ Missing userId or playerId</h2>";
            }
          });
        } else {
          document.body.innerHTML = "<h2>ğŸ”• Notifications not enabled</h2>";
        }
      });
    });
  </script>
</head>
<body>
  <h2>ğŸ”„ Setting up notifications...</h2>
</body>
</html>
